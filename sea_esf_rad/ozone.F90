       
                       module ozone_mod

use time_manager_mod,    only:  time_type
use rad_output_file_mod, only:  hold_qo3
use  utilities_mod,      only:  open_file, file_exist,    &
                                check_nml_error, error_mesg,  &
                                print_version_number, FATAL, NOTE, &
				WARNING, get_my_pe, close_file, &
				get_domain_decomp
use rad_utilities_mod,   only:  Rad_control, radiation_control_type, &
				Environment, environment_type
use rad_step_setup_mod,  only:  temp, jabs, iabs, press, IMINP, &
			        IMAXP, JMINP, JMAXP, KSRAD, KERAD,&
				ISRAD, IERAD, JSRAD, JERAD,  &
			        Rad_time_sv, lat_sv, pflux
use constants_new_mod,   only:  grav
use radiation_diag_mod,  only:  radiag_from_ozone
use zonal_ozone_mod,     only:  zonal_ozone
use calendar_mod,        only:  calendar_4seasons_harmonic, &
				calendar_o3monloss

!--------------------------------------------------------------------

implicit none
private

!-------------------------------------------------------------------
!                      ozone gas module
!
!---------------------------------------------------------------------



!---------------------------------------------------------------------
!----------- ****** VERSION NUMBER ******* ---------------------------

!  character(len=5), parameter  ::  version_number = 'v0.09'
   character(len=128)  :: version =  '$Id: ozone.F90,v 1.2 2001/07/05 17:32:16 fms Exp $'
   character(len=128)  :: tag     =  '$Name: fez $'



!---------------------------------------------------------------------
!-------  interfaces --------

public    &
        ozone_init, ozone_alloc, ozone_dealloc, &
	get_ozone, ozone_time_vary, ozone_drvr


!---------------------------------------------------------------------
!-------- namelist  ---------

logical            :: o3monloss=.false.
character(len=20)  :: o3monloss_type = '    '
character(len=24)  :: basic_ozone_type= 'annual_mean'
logical            :: do_ozone_adjustment = .true.
logical            :: verbose = .false.


namelist /ozone_nml/             &
                       basic_ozone_type, &
                       o3monloss, o3monloss_type, &
		       verbose,    &
		       do_ozone_adjustment

!---------------------------------------------------------------------
!------- public data ------



!---------------------------------------------------------------------
!------- private data ------

logical                      ::  do_tomsprofile1 =.false.
logical                      ::  do_tomsprofile2 =.false.
logical                      ::  do_randelprofile=.false.
logical                      ::  do_annual_mean_ozone=.false.
logical                      ::  do_seasonal_ozone=.false.
logical                      ::  do_column_input=.false.
!!!  SHOULD BE MADE HEIGHT (PRESSURE) DEPENDENT CALCULATION:
integer                      ::  KOBEG_mgroup=1, KOEND_mgroup=15
integer                      ::  KOBEG, KOEND

!     qo3     =  mass mixing ratio of o3 at model data levels.

real, dimension(:,:,:),allocatable          :: qo3

!---------------------------------------------------------------
! ozone depletion profile ---  toms1
!-----------------------------------------------------------------
integer, dimension(60, 4)    ::  o3dept_prof1
integer, dimension(60   )    ::  o3depb_prof1
real   , dimension(60,12)    ::  o3depl_prof1


!--------------------------------------------------------------------
!        o3depl_prof1 = o3 column change in dobson units as a function
!                 of (JD=60) latitudes and 12 months. varies with
!                 season and latitude.
!
!        o3dept_prof1 = index of top skyhi layer in which ozone change
!                 is to occur. varies with seasoe and latitude.
!
!        o3depb_prof1 = index of bottom skyhi layer in which ozone 
!                 change is to occur. varies with latitude.
!
!      in tomsprofile1, (o3dept,o3depb) values assume depletion from
!      the arbitrarily-specified tropopause (as in RSS) to 7 km. above.
!--------------------------------------------------------------------

integer        ::  j
 
      data (o3depl_prof1(j, 1),j= 1,60) /     &
         -14.10,  -14.10,  -14.10,  -14.10,  -14.10,  -14.10, &
         -14.10,  -14.10,  -14.19,  -14.73,  -15.27,  -15.81, &
         -15.25,  -14.47,  -13.69,  -12.52,  -10.96,   -9.40, &
          -7.88,   -6.56,   -5.24,   -3.92,   -2.75,   -1.61, &
          -0.47,    0.38,    0.95,    1.52,    1.98,    1.83, &
           1.68,    1.53,    0.30,   -1.14,   -2.58,   -4.72, &
          -7.57,  -10.43,  -13.47,  -17.52,  -21.57,  -25.62, &
         -27.97,  -29.98,  -31.99,  -32.12,  -30.35,  -28.58, &
         -26.87,  -25.49,  -24.11,  -22.73,  -22.50,  -22.50, &
         -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50  &
                                                            /
      data (o3depl_prof1(j, 2),j= 1,60) /    &
         -15.50,  -15.50,  -15.50,  -15.50,  -15.50,  -15.50, &
         -15.50,  -15.50,  -15.44,  -15.05,  -14.66,  -14.27, &
         -13.25,  -12.11,  -10.97,   -9.67,   -8.19,   -6.73, &
          -5.34,   -4.38,   -3.42,   -2.46,   -1.40,   -0.32, &
           0.76,    1.63,    2.29,    2.95,    3.49,    3.43, &
           3.37,    3.31,    2.23,    0.94,   -0.35,   -2.52, &
          -5.54,   -8.57,  -11.94,  -17.01,  -22.08,  -27.15, &
         -30.62,  -33.77,  -36.92,  -37.74,  -36.21,  -34.68, &
         -33.16,  -31.69,  -30.22,  -28.75,  -28.50,  -28.50, &
         -28.50,  -28.50,  -28.50,  -28.50,  -28.50,  -28.50  &
                                                            /
      data (o3depl_prof1(j, 3),j= 1,60) /  &
         -25.90,  -25.90,  -25.90,  -25.90,  -25.90,  -25.90, &
         -25.90,  -25.90,  -25.49,  -23.03,  -20.57,  -18.11, &
         -16.15,  -14.29,  -12.43,  -10.81,   -9.43,   -8.05, &
          -6.71,   -5.54,   -4.37,   -3.20,   -1.85,   -0.47, &
           0.91,    1.99,    2.77,    3.55,    4.21,    4.30, &
           4.39,    4.48,    3.65,    2.63,    1.61,   -0.28, &
          -3.04,   -5.80,   -8.87,  -13.52,  -18.17,  -22.82, &
         -26.57,  -30.14,  -33.71,  -35.49,  -35.46,  -35.43, &
         -35.29,  -34.60,  -33.90,  -33.21,  -33.10,  -33.10, &
         -33.10,  -33.10,  -33.10,  -33.10,  -33.10,  -33.10  &
                                                            /
      data (o3depl_prof1(j, 4),j= 1,60) /   &
         -36.80,  -36.80,  -36.80,  -36.80,  -36.80,  -36.80, &
         -36.80,  -36.80,  -36.14,  -32.22,  -28.29,  -24.36, &
         -22.00,  -19.96,  -17.92,  -16.12,  -14.56,  -13.00, &
         -11.35,   -9.25,   -7.15,   -5.05,   -3.28,   -1.57, & 
           0.14,    1.33,    1.99,    2.65,    3.22,    3.37, &
           3.52,    3.67,    3.08,    2.33,    1.58,    0.11, &
          -2.08,   -4.27,   -6.60,   -9.63,  -12.67,  -15.70, &
         -18.52,  -21.31,  -24.10,  -26.29,  -27.88,  -29.47, &
         -30.88,  -31.39,  -31.90,  -32.41,  -32.50,  -32.50, &
         -32.50,  -32.50,  -32.50,  -32.50,  -32.50,  -32.50  &
                                                            /
      data (o3depl_prof1(j, 5),j= 1,60) /   &
         -42.70,  -42.70,  -42.70,  -42.70,  -42.70,  -42.70, &
         -42.70,  -42.70,  -41.97,  -37.59,  -33.21,  -28.83, &
         -26.70,  -25.02,  -23.34,  -21.45,  -19.35,  -17.25, &
         -14.98,  -11.83,   -8.68,   -5.53,   -3.68,   -2.09, &
          -0.50,    0.39,    0.57,    0.75,    0.91,    0.97, &
           1.03,    1.09,    0.60,    0.00,   -0.60,   -1.68, &
          -3.24,   -4.80,   -6.29,   -7.46,   -8.63,   -9.81, &
         -11.10,  -12.42,  -13.74,  -15.52,  -17.77,  -20.02, &
         -22.11,  -23.37,  -24.63,  -25.89,  -26.10,  -26.10, &
         -26.10,  -26.10,  -26.10,  -26.10,  -26.10,  -26.10  &
                                                            /  
      data (o3depl_prof1(j, 6),j= 1,60) /   &
         -44.50,  -44.50,  -44.50,  -44.50,  -44.50,  -44.50, &
         -44.50,  -44.50,  -43.74,  -39.15,  -34.56,  -29.97, &
         -27.83,  -26.18,  -24.53,  -22.32,  -19.56,  -16.80, &
         -13.91,  -10.34,   -6.76,   -3.19,   -1.73,   -0.68, &
           0.37,    0.57,   -0.09,   -0.75,   -1.34,   -1.61, &
          -1.88,   -2.16,   -2.57,   -3.02,   -3.47,   -4.19, &
          -5.19,   -6.17,   -7.00,   -7.03,   -7.06,   -7.09, &
          -7.22,   -7.37,   -7.52,   -8.51,  -10.34,  -12.17, &
         -13.91,  -15.20,  -16.50,  -17.78,  -18.00,  -18.00, &
         -18.00,  -18.00,  -18.00,  -18.00,  -18.00,  -18.00  &
                                                            / 
      data (o3depl_prof1(j, 7),j= 1,60) /  &
         -47.20,  -47.20,  -47.20,  -47.20,  -47.20,  -47.20, &
         -47.20,  -47.20,  -46.26,  -40.62,  -34.98,  -29.34, &
         -26.23,  -23.62,  -21.01,  -18.13,  -14.98,  -11.83, &
          -8.68,   -5.56,   -2.44,    0.68,    1.50,    1.86, &
           2.22,    1.73,    0.38,   -0.97,   -2.20,   -2.83, &
          -3.46,   -4.09,   -4.42,   -4.69,   -4.96,   -5.40, &
          -6.00,   -6.60,   -7.06,   -6.82,   -6.58,   -6.34, &
          -6.20,   -6.08,   -5.96,   -6.50,   -7.70,   -8.90, &
         -10.06,  -11.02,  -11.98,  -12.94,  -13.10,  -13.10, &
         -13.10,  -13.10,  -13.10,  -13.10,  -13.10,  -13.10  &
                                                            /
      data (o3depl_prof1(j, 8),j= 1,60) /    &
         -53.00,  -53.00,  -53.00,  -53.00,  -53.00,  -53.00, &
         -53.00,  -53.00,  -51.77,  -44.39,  -37.01,  -29.63, &
         -24.85,  -20.59,  -16.33,  -12.67,   -9.61,   -6.55, &
          -3.64,   -1.45,    0.74,    2.93,    3.40,    3.52,&
           3.64,    2.95,    1.45,   -0.05,   -1.44,   -2.31, &
          -3.18,   -4.05,   -4.32,   -4.47,   -4.62,   -4.88, &
          -5.24,   -5.60,   -5.89,   -5.83,   -5.77,   -5.71, &
          -5.95,   -6.25,   -6.55,   -7.31,   -8.54,   -9.77, &
         -10.92,  -11.67,  -12.43,  -13.18,  -13.30,  -13.30, &
         -13.30,  -13.30,  -13.30,  -13.30,  -13.30,  -13.30  &
                                                            /
      data (o3depl_prof1(j, 9),j= 1,60) /   &
         -57.60,  -57.60,  -57.60,  -57.60,  -57.60,  -57.60, &
         -57.60,  -57.60,  -56.21,  -47.90,  -39.60,  -31.28, &
         -25.35,  -19.89,  -14.43,  -10.43,   -7.87,   -5.33, &
          -2.95,   -1.42,    0.11,    1.65,    2.30,    2.78, &
           3.26,    2.98,    1.93,    0.88,   -0.14,   -0.98, &
          -1.82,   -2.66,   -2.95,   -3.13,   -3.31,   -3.61, &
          -4.03,   -4.45,   -4.81,   -4.87,   -4.93,   -4.99, &
          -5.60,   -6.32,   -7.04,   -8.28,  -10.06,  -11.82, &
         -13.45,  -14.35,  -15.25,  -16.15,  -16.30,  -16.30, &
         -16.30,  -16.30,  -16.30,  -16.30,  -16.30,  -16.30  &
                                                            /
      data (o3depl_prof1(j,10),j= 1,60) /   &
         -54.30,  -54.30,  -54.30,  -54.30,  -54.30,  -54.30, &
         -54.30,  -54.30,  -53.12,  -46.01,  -38.89,  -31.79, &
         -26.33,  -21.20,  -16.07,  -12.50,  -10.49,   -8.48, &
          -6.56,   -5.09,   -3.62,   -2.14,   -0.98,    0.13, &
           1.24,    1.63,    1.30,    0.98,    0.60,   -0.03, &
          -0.66,   -1.30,   -1.77,   -2.22,   -2.67,   -3.30, &
          -4.11,   -4.92,   -5.63,   -5.81,   -5.99,   -6.17, &
          -6.82,   -7.57,   -8.32,   -9.69,  -11.67,  -13.65, &
         -15.46,  -16.42,  -17.38,  -18.34,  -18.50,  -18.50, &
         -18.50,  -18.50,  -18.50,  -18.50,  -18.50,  -18.50  &
                                                            /
      data (o3depl_prof1(j,11),j= 1,60) /  &
         -41.20,  -41.20,  -41.20,  -41.20,  -41.20,  -41.20, &
         -41.20,  -41.20,  -40.54,  -36.55,  -32.56,  -28.57, &
         -25.03,  -21.58,  -18.12,  -15.55,  -13.84,  -12.12, &
         -10.42,   -8.74,   -7.06,   -5.38,   -3.85,   -2.35, &
          -0.85,    0.03,    0.30,    0.57,    0.74,    0.35, &
          -0.04,   -0.43,   -1.27,   -2.20,   -3.13,   -4.35, &
          -5.85,   -7.35,   -8.74,   -9.54,  -10.35,  -11.16, &
         -11.85,  -12.51,  -13.17,  -14.02,  -15.07,  -16.12, &
         -17.08,  -17.59,  -18.11,  -18.62,  -18.70,  -18.70, &
         -18.70,  -18.70,  -18.70,  -18.70,  -18.70,  -18.70  &
                                                            /
      data (o3depl_prof1(j,12),j= 1,60) /   &
         -24.50,  -24.50,  -24.50,  -24.50,  -24.50,  -24.50,  &
         -24.50,  -24.50,  -24.37,  -23.56,  -22.75,  -21.94, &
         -20.48,  -18.88,  -17.30,  -15.69,  -14.07,  -12.45, &
         -10.82,   -9.14,   -7.46,   -5.78,   -4.33,   -2.92, &
          -1.50,   -0.53,    0.01,    0.55,    0.96,    0.72, &
           0.48,    0.24,   -0.90,   -2.22,   -3.54,   -5.32, &
          -7.57,   -9.82,  -12.08,  -14.36,  -16.64,  -18.92, &
         -20.15,  -21.17,  -22.19,  -22.40,  -21.80,  -21.20, &
         -20.62,  -20.14,  -19.66,  -19.18,  -19.10,  -19.10, &
         -19.10,  -19.10,  -19.10,  -19.10,  -19.10,  -19.10  &
                                                            /
 
      data (o3depb_prof1(j),j=1,60) /   &
         5*29, 8*28, 7*27, 5*26, 4*25, 2*24, 4*25, 5*26, 7*27,   &
         8*28, 5*29                                         /
 
      data (o3dept_prof1(j,1),j= 1,60) /  &
         5*25, 8*24, 7*23, 5*22, 4*21, 2*20, 4*21, 5*22, 7*23, &
         13*24                                               /
      data (o3dept_prof1(j,2),j= 1,60) /  &
         5*25, 8*24, 7*23, 5*22, 4*21, 2*20, 4*21, 5*22, 7*23, &
         8*24, 5*25                                         /
      data (o3dept_prof1(j,3),j= 1,60) / &
         5*24, 3*23, 5*24, 7*23, 5*22, 4*21, 2*20, 4*21, 5*22, 7*23,  &
         8*24, 5*25                                         /
      data (o3dept_prof1(j,4),j= 1,60) / &
         5*24, 3*23, 5*24, 7*23, 5*22, 4*21, 2*20, 4*21, 5*22, 7*23, &
         8*24, 5*25                                         /



!--------------------------------------------------------------------
!  ozone depletion profile --- toms2
!---------------------------------------------------------------------

integer, dimension (60, 4)           :: o3dept_prof2
integer, dimension (60   )           :: o3depb_prof2
real   , dimension (60,12)           :: o3depl_prof2

!-----------------------------------------------------------------
!        o3depl_prof2 = o3 column change in dobson units as a function
!                 of (JD=60) latitudes and 12 months. varies with
!                 season and latitude.
!
!        o3dept_prof2 = index of top skyhi layer in which ozone change
!                 is to occur. varies with season and latitude.
!
!        o3depb_prof2 = index of bottom skyhi layer in which ozone 
!                  change is to occur. varies with latitude.
!
!      in tomsprofile2, (o3dept,o3depb) values assume depletion from
!      the arbitrarily-specified tropopause (as in RSS) to 10 km. above.
!----------------------------------------------------------------------


      data (o3depl_prof2(j, 1),j= 1,60) /   &
         -14.10,  -14.10,  -14.10,  -14.10,  -14.10,  -14.10,  &
         -14.10,  -14.10,  -14.19,  -14.73,  -15.27,  -15.81, &
         -15.25,  -14.47,  -13.69,  -12.52,  -10.96,   -9.40, &
          -7.88,   -6.56,   -5.24,   -3.92,   -2.75,   -1.61, &
          -0.47,    0.38,    0.95,    1.52,    1.98,    1.83, &
           1.68,    1.53,    0.30,   -1.14,   -2.58,   -4.72, &
          -7.57,  -10.43,  -13.47,  -17.52,  -21.57,  -25.62, &
         -27.97,  -29.98,  -31.99,  -32.12,  -30.35,  -28.58, &
         -26.87,  -25.49,  -24.11,  -22.73,  -22.50,  -22.50, &
         -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50  &
                                                            /
      data (o3depl_prof2(j, 2),j= 1,60) /  &
         -15.50,  -15.50,  -15.50,  -15.50,  -15.50,  -15.50, &
         -15.50,  -15.50,  -15.44,  -15.05,  -14.66,  -14.27, &
         -13.25,  -12.11,  -10.97,   -9.67,   -8.19,   -6.73, &
          -5.34,   -4.38,   -3.42,   -2.46,   -1.40,   -0.32, &
           0.76,    1.63,    2.29,    2.95,    3.49,    3.43, &
           3.37,    3.31,    2.23,    0.94,   -0.35,   -2.52, &
          -5.54,   -8.57,  -11.94,  -17.01,  -22.08,  -27.15, &
         -30.62,  -33.77,  -36.92,  -37.74,  -36.21,  -34.68, &
         -33.16,  -31.69,  -30.22,  -28.75,  -28.50,  -28.50, &
         -28.50,  -28.50,  -28.50,  -28.50,  -28.50,  -28.50  &
                                                            /
      data (o3depl_prof2(j, 3),j= 1,60) / &
         -25.90,  -25.90,  -25.90,  -25.90,  -25.90,  -25.90, &
         -25.90,  -25.90,  -25.49,  -23.03,  -20.57,  -18.11, &
         -16.15,  -14.29,  -12.43,  -10.81,   -9.43,   -8.05,&
          -6.71,   -5.54,   -4.37,   -3.20,   -1.85,   -0.47, &
           0.91,    1.99,    2.77,    3.55,    4.21,    4.30, &
           4.39,    4.48,    3.65,    2.63,    1.61,   -0.28, &
          -3.04,   -5.80,   -8.87,  -13.52,  -18.17,  -22.82, &
         -26.57,  -30.14,  -33.71,  -35.49,  -35.46,  -35.43, &
         -35.29,  -34.60,  -33.90,  -33.21,  -33.10,  -33.10, &
         -33.10,  -33.10,  -33.10,  -33.10,  -33.10,  -33.10  &
                                                            /
      data (o3depl_prof2(j, 4),j= 1,60) /   &
         -36.80,  -36.80,  -36.80,  -36.80,  -36.80,  -36.80, &
         -36.80,  -36.80,  -36.14,  -32.22,  -28.29,  -24.36, &
         -22.00,  -19.96,  -17.92,  -16.12,  -14.56,  -13.00, &
         -11.35,   -9.25,   -7.15,   -5.05,   -3.28,   -1.57, &
           0.14,    1.33,    1.99,    2.65,    3.22,    3.37, &
           3.52,    3.67,    3.08,    2.33,    1.58,    0.11, &
          -2.08,   -4.27,   -6.60,   -9.63,  -12.67,  -15.70, &
         -18.52,  -21.31,  -24.10,  -26.29,  -27.88,  -29.47, &
         -30.88,  -31.39,  -31.90,  -32.41,  -32.50,  -32.50, &
         -32.50,  -32.50,  -32.50,  -32.50,  -32.50,  -32.50  &
                                                            /
      data (o3depl_prof2(j, 5),j= 1,60) /  &
         -42.70,  -42.70,  -42.70,  -42.70,  -42.70,  -42.70, &
         -42.70,  -42.70,  -41.97,  -37.59,  -33.21,  -28.83, &
         -26.70,  -25.02,  -23.34,  -21.45,  -19.35,  -17.25, &
         -14.98,  -11.83,   -8.68,   -5.53,   -3.68,   -2.09, &
          -0.50,    0.39,    0.57,    0.75,    0.91,    0.97, &
           1.03,    1.09,    0.60,    0.00,   -0.60,   -1.68, &
          -3.24,   -4.80,   -6.29,   -7.46,   -8.63,   -9.81, &
         -11.10,  -12.42,  -13.74,  -15.52,  -17.77,  -20.02,&
         -22.11,  -23.37,  -24.63,  -25.89,  -26.10,  -26.10, &
         -26.10,  -26.10,  -26.10,  -26.10,  -26.10,  -26.10  &
                                                            /
      data (o3depl_prof2(j, 6),j= 1,60) / &
         -44.50,  -44.50,  -44.50,  -44.50,  -44.50,  -44.50, &
         -44.50,  -44.50,  -43.74,  -39.15,  -34.56,  -29.97, &
         -27.83,  -26.18,  -24.53,  -22.32,  -19.56,  -16.80, &
         -13.91,  -10.34,   -6.76,   -3.19,   -1.73,   -0.68, &
           0.37,    0.57,   -0.09,   -0.75,   -1.34,   -1.61, &
          -1.88,   -2.16,   -2.57,   -3.02,   -3.47,   -4.19, &
          -5.19,   -6.17,   -7.00,   -7.03,   -7.06,   -7.09, &
          -7.22,   -7.37,   -7.52,   -8.51,  -10.34,  -12.17, &
         -13.91,  -15.20,  -16.50,  -17.78,  -18.00,  -18.00, & 
         -18.00,  -18.00,  -18.00,  -18.00,  -18.00,  -18.00  &
                                                            /
      data (o3depl_prof2(j, 7),j= 1,60) /  &
         -47.20,  -47.20,  -47.20,  -47.20,  -47.20,  -47.20, &
         -47.20,  -47.20,  -46.26,  -40.62,  -34.98,  -29.34,&
         -26.23,  -23.62,  -21.01,  -18.13,  -14.98,  -11.83,&
          -8.68,   -5.56,   -2.44,    0.68,    1.50,    1.86,&
           2.22,    1.73,    0.38,   -0.97,   -2.20,   -2.83, &
          -3.46,   -4.09,   -4.42,   -4.69,   -4.96,   -5.40, &
          -6.00,   -6.60,   -7.06,   -6.82,   -6.58,   -6.34, &
          -6.20,   -6.08,   -5.96,   -6.50,   -7.70,   -8.90, &
         -10.06,  -11.02,  -11.98,  -12.94,  -13.10,  -13.10, &
         -13.10,  -13.10,  -13.10,  -13.10,  -13.10,  -13.10  &
                                                            /
      data (o3depl_prof2(j, 8),j= 1,60) /   &
         -53.00,  -53.00,  -53.00,  -53.00,  -53.00,  -53.00, &
         -53.00,  -53.00,  -51.77,  -44.39,  -37.01,  -29.63, &
         -24.85,  -20.59,  -16.33,  -12.67,   -9.61,   -6.55, &
          -3.64,   -1.45,    0.74,    2.93,    3.40,    3.52, &
           3.64,    2.95,    1.45,   -0.05,   -1.44,   -2.31, &
          -3.18,   -4.05,   -4.32,   -4.47,   -4.62,   -4.88, &
          -5.24,   -5.60,   -5.89,   -5.83,   -5.77,   -5.71, &
          -5.95,   -6.25,   -6.55,   -7.31,   -8.54,   -9.77,&
         -10.92,  -11.67,  -12.43,  -13.18,  -13.30,  -13.30, &
         -13.30,  -13.30,  -13.30,  -13.30,  -13.30,  -13.30  &
                                                            /
      data (o3depl_prof2(j, 9),j= 1,60) /   &
         -57.60,  -57.60,  -57.60,  -57.60,  -57.60,  -57.60, &
         -57.60,  -57.60,  -56.21,  -47.90,  -39.60,  -31.28, &
         -25.35,  -19.89,  -14.43,  -10.43,   -7.87,   -5.33, &
          -2.95,   -1.42,    0.11,    1.65,    2.30,    2.78,&
           3.26,    2.98,    1.93,    0.88,   -0.14,   -0.98,&
          -1.82,   -2.66,   -2.95,   -3.13,   -3.31,   -3.61,&
          -4.03,   -4.45,   -4.81,   -4.87,   -4.93,   -4.99, &
          -5.60,   -6.32,   -7.04,   -8.28,  -10.06,  -11.82, &
         -13.45,  -14.35,  -15.25,  -16.15,  -16.30,  -16.30, &
         -16.30,  -16.30,  -16.30,  -16.30,  -16.30,  -16.30  &
                                                            /
      data (o3depl_prof2(j,10),j= 1,60) /  &
         -54.30,  -54.30,  -54.30,  -54.30,  -54.30,  -54.30, &
         -54.30,  -54.30,  -53.12,  -46.01,  -38.89,  -31.79, &
         -26.33,  -21.20,  -16.07,  -12.50,  -10.49,   -8.48, &
          -6.56,   -5.09,   -3.62,   -2.14,   -0.98,    0.13, &
           1.24,    1.63,    1.30,    0.98,    0.60,   -0.03, &
          -0.66,   -1.30,   -1.77,   -2.22,   -2.67,   -3.30, &
          -4.11,   -4.92,   -5.63,   -5.81,   -5.99,   -6.17, &
          -6.82,   -7.57,   -8.32,   -9.69,  -11.67,  -13.65, &
         -15.46,  -16.42,  -17.38,  -18.34,  -18.50,  -18.50, &
         -18.50,  -18.50,  -18.50,  -18.50,  -18.50,  -18.50  &
                                                            /
      data (o3depl_prof2(j,11),j= 1,60) / &
         -41.20,  -41.20,  -41.20,  -41.20,  -41.20,  -41.20,  &
         -41.20,  -41.20,  -40.54,  -36.55,  -32.56,  -28.57, &
         -25.03,  -21.58,  -18.12,  -15.55,  -13.84,  -12.12, &
         -10.42,   -8.74,   -7.06,   -5.38,   -3.85,   -2.35, &
          -0.85,    0.03,    0.30,    0.57,    0.74,    0.35, & 
          -0.04,   -0.43,   -1.27,   -2.20,   -3.13,   -4.35, &
          -5.85,   -7.35,   -8.74,   -9.54,  -10.35,  -11.16, &
         -11.85,  -12.51,  -13.17,  -14.02,  -15.07,  -16.12, &
         -17.08,  -17.59,  -18.11,  -18.62,  -18.70,  -18.70, &
         -18.70,  -18.70,  -18.70,  -18.70,  -18.70,  -18.70  &
                                                            /
      data (o3depl_prof2(j,12),j= 1,60) /   &
         -24.50,  -24.50,  -24.50,  -24.50,  -24.50,  -24.50, &
         -24.50,  -24.50,  -24.37,  -23.56,  -22.75,  -21.94, &
         -20.48,  -18.88,  -17.30,  -15.69,  -14.07,  -12.45, &
         -10.82,   -9.14,   -7.46,   -5.78,   -4.33,   -2.92, &
          -1.50,   -0.53,    0.01,    0.55,    0.96,    0.72, &
           0.48,    0.24,   -0.90,   -2.22,   -3.54,   -5.32, &
          -7.57,   -9.82,  -12.08,  -14.36,  -16.64,  -18.92, &
         -20.15,  -21.17,  -22.19,  -22.40,  -21.80,  -21.20, &
         -20.62,  -20.14,  -19.66,  -19.18,  -19.10,  -19.10, &
         -19.10,  -19.10,  -19.10,  -19.10,  -19.10,  -19.10  &
                                                            /  
      data (o3depb_prof2(j),j=1,60) /  &
         5*29, 8*28, 7*27, 5*26, 4*25, 2*24, 4*25, 5*26, 7*27,  &
         8*28, 5*29                                         /   
 
      data (o3dept_prof2(j,1),j= 1,60) /   &
         5*23, 8*22, 7*21, 5*20, 4*19, 2*18, 4*19, 5*20, 7*21,  &
         13*22                                               /
      data (o3dept_prof2(j,2),j= 1,60) /  &
         5*23, 8*22, 7*21, 5*20, 4*19, 2*18, 4*19, 5*20, 7*21,&
         8*22, 5*23                                         /
      data (o3dept_prof2(j,3),j= 1,60) /  &
         5*22, 3*21, 5*22, 7*21, 5*20, 4*19, 2*18, 4*19, 5*20, 7*21, &
         8*22, 5*23                                         /
      data (o3dept_prof2(j,4),j= 1,60) /  &
         5*22, 3*21, 5*22, 7*21, 5*20, 4*19, 2*18, 4*19, 5*20, 7*21,  &
         8*22, 5*23                                         /
 
!---------------------------------------------------------------------
!     level index values and depletions at the current time
!---------------------------------------------------------------------
integer, dimension (:), allocatable      ::  izdepb, izdept
real   , dimension (:), allocatable      ::  zdoblos

integer                                  ::  jj, kk

!-----------------------------------------------------------------------
!     temperature distribution used for ozone photochemical damping.
!-----------------------------------------------------------------------
real, dimension(20,18)    :: tradin

      data ((tradin(kk,jj),kk=1,20),jj=1,9)/   &
        184.3E+00, 200.6E+00, 211.0E+00, 221.1E+00, 233.4E+00, &
        241.2E+00, 245.5E+00, 245.7E+00, 245.7E+00, 240.0E+00,&
        230.7E+00, 222.3E+00, 214.7E+00, 208.3E+00, 203.0E+00,&
        198.6E+00, 194.9E+00, 192.2E+00, 190.2E+00, 188.6E+00,&
        184.6E+00, 200.9E+00, 211.3E+00, 221.6E+00, 233.8E+00,&
        241.6E+00, 246.0E+00, 246.5E+00, 246.8E+00, 240.9E+00, &
        231.6E+00, 223.1E+00, 215.5E+00, 209.2E+00, 203.7E+00, &
        199.4E+00, 195.7E+00, 192.9E+00, 190.9E+00, 189.4E+00, &
        185.2E+00, 201.6E+00, 212.0E+00, 222.4E+00, 234.8E+00, &
        242.7E+00, 247.2E+00, 247.9E+00, 248.5E+00, 242.7E+00, &
        233.3E+00, 224.8E+00, 217.2E+00, 210.7E+00, 205.1E+00, &
        200.8E+00, 197.1E+00, 194.2E+00, 192.0E+00, 190.5E+00, &
        186.1E+00, 202.8E+00, 213.2E+00, 223.7E+00, 236.5E+00, &
        244.4E+00, 249.1E+00, 250.0E+00, 250.9E+00, 245.5E+00, &
        236.0E+00, 227.4E+00, 219.8E+00, 213.0E+00, 207.4E+00, &
        202.9E+00, 199.3E+00, 196.1E+00, 193.8E+00, 192.2E+00, &
        187.4E+00, 204.0E+00, 214.6E+00, 225.2E+00, 238.1E+00, &
        246.3E+00, 251.2E+00, 252.4E+00, 253.7E+00, 249.3E+00, &
        239.9E+00, 231.2E+00, 223.3E+00, 216.4E+00, 210.6E+00, &
        205.8E+00, 202.1E+00, 199.1E+00, 196.8E+00, 195.1E+00, &
        189.1E+00, 205.5E+00, 216.1E+00, 226.8E+00, 239.8E+00, &
        248.2E+00, 253.4E+00, 255.2E+00, 257.2E+00, 253.8E+00, &
        244.7E+00, 236.1E+00, 228.0E+00, 220.8E+00, 214.6E+00, &
        209.8E+00, 205.8E+00, 202.9E+00, 200.9E+00, 199.3E+00, &
        190.5E+00, 206.8E+00, 217.5E+00, 228.3E+00, 241.3E+00, &
        250.0E+00, 255.6E+00, 257.8E+00, 260.2E+00, 257.9E+00, &
        249.2E+00, 240.7E+00, 232.4E+00, 224.9E+00, 218.8E+00, &
        213.6E+00, 209.9E+00, 206.7E+00, 204.6E+00, 203.0E+00, &
        191.6E+00, 208.1E+00, 218.9E+00, 230.0E+00, 242.7E+00, &
        251.6E+00, 257.8E+00, 260.2E+00, 262.8E+00, 261.5E+00, &
        253.1E+00, 244.8E+00, 236.7E+00, 229.3E+00, 223.0E+00, &
        217.9E+00, 214.0E+00, 211.1E+00, 209.1E+00, 207.2E+00, &
        192.8E+00, 209.2E+00, 220.2E+00, 231.3E+00, 244.0E+00, &
        253.1E+00, 259.6E+00, 262.1E+00, 264.9E+00, 264.2E+00, &
        256.6E+00, 248.3E+00, 240.6E+00, 233.3E+00, 227.0E+00, &
        221.9E+00, 218.0E+00, 215.0E+00, 212.9E+00, 211.1E+00 / 

      data ((tradin (kk,jj),kk=1,20),jj=10,18)/   &
        194.0E+00, 210.4E+00, 221.2E+00, 232.5E+00, 245.3E+00, &
        254.7E+00, 261.1E+00, 263.7E+00, 266.4E+00, 266.1E+00, &
        259.8E+00, 251.0E+00, 244.2E+00, 237.5E+00, 231.2E+00,&
        226.0E+00, 222.2E+00, 219.4E+00, 217.2E+00, 215.4E+00, &
        195.2E+00, 211.3E+00, 222.1E+00, 233.4E+00, 246.3E+00, &
        255.9E+00, 262.2E+00, 265.1E+00, 267.6E+00, 267.4E+00, &
        262.2E+00, 253.4E+00, 247.1E+00, 241.0E+00, 234.6E+00, &
        229.6E+00, 225.5E+00, 222.6E+00, 220.5E+00, 218.0E+00, &
        196.2E+00, 212.1E+00, 223.0E+00, 234.0E+00, 247.0E+00, &
        256.7E+00, 263.1E+00, 266.2E+00, 268.7E+00, 268.3E+00, &
        264.2E+00, 255.9E+00, 249.9E+00, 244.2E+00, 238.2E+00, &
        233.0E+00, 229.3E+00, 226.4E+00, 224.3E+00, 221.1E+00, &
        197.0E+00, 212.7E+00, 223.7E+00, 234.8E+00, 247.7E+00, &
        257.3E+00, 263.8E+00, 267.1E+00, 269.4E+00, 268.9E+00, &
        265.6E+00, 257.9E+00, 252.1E+00, 246.8E+00, 241.0E+00, &
        235.9E+00, 232.2E+00, 229.5E+00, 227.2E+00, 223.0E+00, &
        197.3E+00, 213.1E+00, 224.2E+00, 235.6E+00, 248.2E+00, &
        257.9E+00, 264.4E+00, 267.8E+00, 269.8E+00, 269.4E+00, &
        266.7E+00, 259.6E+00, 254.0E+00, 249.1E+00, 243.2E+00, &
        238.5E+00, 234.9E+00, 232.2E+00, 229.9E+00, 224.9E+00, &
        198.0E+00, 213.7E+00, 224.7E+00, 236.3E+00, 248.9E+00,    &
        258.6E+00, 265.1E+00, 268.6E+00, 270.3E+00, 269.7E+00, &
        267.4E+00, 260.9E+00, 255.6E+00, 250.8E+00, 245.1E+00, &
        240.5E+00, 237.0E+00, 234.4E+00, 231.6E+00, 226.4E+00, &
        198.7E+00, 214.3E+00, 225.4E+00, 237.1E+00, 249.8E+00, &
        259.5E+00, 265.7E+00, 269.4E+00, 270.8E+00, 269.9E+00, &
        267.8E+00, 261.8E+00, 256.7E+00, 251.9E+00, 246.3E+00, &
        241.7E+00, 238.3E+00, 235.5E+00, 232.4E+00, 226.9E+00, &
        199.3E+00, 215.1E+00, 226.0E+00, 237.8E+00, 250.6E+00, &
        260.3E+00, 266.4E+00, 269.9E+00, 270.9E+00, 269.8E+00, &
        268.0E+00, 262.5E+00, 257.6E+00, 253.0E+00, 247.5E+00, &
        242.8E+00, 239.5E+00, 236.7E+00, 233.3E+00, 227.6E+00, &
        199.9E+00, 215.8E+00, 226.7E+00, 238.6E+00, 251.1E+00, &
        261.0E+00, 267.2E+00, 270.2E+00, 270.7E+00, 269.5E+00, &
        267.9E+00, 262.9E+00, 258.1E+00, 253.6E+00, 248.1E+00, &
        243.2E+00, 239.9E+00, 236.9E+00, 233.4E+00, 227.5E+00 /


real, dimension(:,:), allocatable        :: ztrad, ztrad1, ztrad2

!--------------------------------------------------------------------
!  arrays for seasonal ozone distribution
!--------------------------------------------------------------------
real, dimension(:,:), allocatable     ::  xo3ws, xo3sf

!--------------------------------------------------------------------
!  array for annual mean ozone distribution
!--------------------------------------------------------------------
real, dimension(:,:), allocatable     ::  xo3ann

!--------------------------------------------------------------------
!  ozone amounts (mass mixing ratio)  at model latitudes and levels at
!  current time.
!--------------------------------------------------------------------
real, dimension (:,:),allocatable   ::  zdduo3n

!------------------------------------------------------------------
!   qo3_randel = ozone profiles (mass mixing ratio in g/g) as
!                a function of month and altitude
!
!      in randelprofile, an ozone profile is created based on the
!      depletions given by randel from a standard ozone profile
!      (taken from SKYHI averaged ozone profiles, zonally averaged,
!      as a function of month and altitude.)
!--------------------------------------------------------------------
real, dimension(:,:,:), allocatable    ::  qo3_randel

!-------------------------------------------------------------------
!  qqo3 is a single column of ozone mass mixing ratio (g/g)
!  inputted from file id1o3. these data are used in singlecolumn
!  radiation calculations
!-------------------------------------------------------------------
real, dimension (:), allocatable        ::  qqo3

!-------------------------------------------------------------------
real    :: bb1 =  510.0
real    :: bb2 = 2300.0
real    :: con1 
integer :: kmin, kmax
integer :: x(4), y(4), jdf, jd




!-------------------------------------------------------------------
!-------------------------------------------------------------------



      contains



subroutine ozone_init (kmin_in, kmax_in)

integer, intent(in)  :: kmin_in, kmax_in

!-----------------------------------------------------------------
      integer           ::  unit, ierr, io
      integer           ::  iounit, nt, ll, k, j, jj
      real              ::  tmean, fudgek, fl

      real, dimension(:,:), allocatable   :: qo3_read, ztradgl

!---------------------------------------------------------------------
!-----  read namelist  ------
  
      if (file_exist('input.nml')) then
        unit =  open_file ('input.nml', action='read')
        ierr=1; do while (ierr /= 0)
        read (unit, nml=ozone_nml, iostat=io, end=10)
        ierr = check_nml_error (io, 'ozone_nml')
        enddo
10      call close_file (unit)
      endif

      unit = open_file ('logfile.out', action='append')
!     call print_version_number (unit, 'ozone', version_number)
      if (get_my_pe() == 0) then
	write (unit,'(/,80("="),/(a))') trim(version), trim(tag)
	write (unit,nml=ozone_nml)
      endif
      call close_file (unit)

      kmin = kmin_in
      kmax = kmax_in
      call get_domain_decomp (x, y)
      jdf = y(4) - y(3) + 1
      jd  = y(2)

      if (Environment%using_sky_periphs .and. kmax == 40) then
        KOBEG = KOBEG_mgroup
        KOEND = KOEND_mgroup
        allocate ( izdepb (jdf) )
        allocate ( izdept (jdf) ) 
        allocate ( zdoblos (jdf) ) 
        if (o3monloss) then
	  if (trim(o3monloss_type) == 'tomsprofile1') then
	    do_tomsprofile1 = .true.
          else if (trim(o3monloss_type) == 'tomsprofile2') then
	    do_tomsprofile2 = .true.
          else
	    call error_mesg ( 'ozone_init',    &
                 ' o3monloss_type is not an acceptable value.', FATAL)
          endif
        endif

!------------------------------------------------------------------
!    use the annual mean ozone data.
!-------------------------------------------------------------------
        if (trim(basic_ozone_type) == 'annual_mean' ) then
	  do_annual_mean_ozone = .true.
          allocate ( xo3ann(19, KMAX) )
          iounit = open_file ('INPUT/annual_mean_ozone',   &
			      form='formatted', action='read')
          do k=1,KMAX
            read (iounit, FMT = '(4e13.5)') (xo3ann(j,k), j=1,19)
          end do
          call close_file (iounit)

!------------------------------------------------------------------
!    use the seasonal ozone data.
!-------------------------------------------------------------------
        else if (trim(basic_ozone_type) == 'seasonally_varying' ) then
	  do_seasonal_ozone = .true.
	  allocate ( xo3sf(19, KMAX) )
	  allocate ( xo3ws(19, KMAX) )
	  iounit = open_file ('INPUT/seasonal_ozone',   &
			      form='formatted', action='read')
          do k=1,KMAX
            read (iounit, FMT = '(4e18.10)') (xo3sf(j,k), j=1,19)
          end do
          do k=1,KMAX
            read (iounit, FMT = '(4e18.10)') (xo3ws(j,k), j=1,19)
          end do
          call close_file (iounit)

!------------------------------------------------------------------
!    use the ozone data file for the randel profile case
!-----------------------------------------------------------------
        else if (trim(basic_ozone_type) == 'randelprofile' ) then
	  do_randelprofile = .true.
          allocate (qo3_read(KMIN:KMAX, 12) )
	  allocate (qo3_randel(jdf, KMIN:KMAX, 12) )
	  iounit = open_file ('INPUT/randelo3data', form='formatted',  &
                               action= 'read')
          do nt = 1,12
	    jj= 0
            do j=1,jd
              read (iounit, FMT = '(5E14.6)')     &
                                     (qo3_read(k,nt),k=KMIN,KMAX)
              if (j >= y(3) .and. j <= y(4) ) then
		jj = jj + 1
		qo3_randel(jj,KMIN:KMAX,nt) = qo3_read(KMIN:KMAX,nt)
              endif
            enddo
          enddo
	  deallocate (qo3_read)
          call close_file (iounit)

!------------------------------------------------------------------
!    read a single column ozone profile
!-----------------------------------------------------------------
        else if (trim(basic_ozone_type) == 'input' ) then
	  if (file_exist ( 'INPUT/id1o3') ) then
            do_column_input = .true.
            allocate (qqo3(KMIN:KMAX) )
            iounit = open_file ('INPUT/id1o3', form='formatted',  &
                                 action= 'read')
            read (iounit,FMT = '(5e18.10)') (qqo3(k),k=KMIN,KMAX)
	    call close_file (iounit)
          else
	    call error_mesg ( 'ozone_init', &
		  'desired ozone input file is not present',FATAL)
          endif

!------------------------------------------------------------------
!    error condition -- improper basic_ozone_type
!-----------------------------------------------------------------
        else
          call error_mesg ( 'ozone_init',    &
                 ' basic_ozone_type is not an acceptable value.', FATAL)
        endif
	
!-----------------------------------------------------------------------
!     define constants used in photochemical ozone adjustment.  as of
!     jan82, ztrad1, ztrad2, and con1 reflect new radiative damping
!     rates.
!-----------------------------------------------------------------------
        if (do_ozone_adjustment) then
          tmean  = 265.0E+00
          fudgek = 4.0E+00
          con1   = fudgek*EXP(-bb2/tmean)

!-----------------------------------------------------------------------
!     define radiative damping rates for ozone (ztrad, ztrad1, ztrad2).
!     first define ztrad, which is the input value if the n18 resolution
!     is chosen, but which must be interpolated in latitude if other
!     latitudinal resolution is specified. values of ztrad, ztrad1 and
!     ztrad2 are defined at 87.5, 82.5, 77.5, 72.5,..., 7.5, 2.5 degrees
!     latitude, and symmetry is assumed between northern and southern
!     hemispheres. 
!-----------------------------------------------------------------------
          allocate (ztradgl (jd, KOBEG:KOEND) )
          allocate (ztrad   (jdf, KOBEG:KOEND) )
          allocate (ztrad1  (jdf, KOBEG:KOEND) )
          allocate (ztrad2  (jdf, KOBEG:KOEND) )

          if (jd .NE. 36) then
            do j=1,jd/2
              fl = 0.5E+00 + 18.0/jd + (j - 1)*(36.0/jd)
              ll = fl
              ll = MIN0(MAX0(ll,1),17)
              do k=KOBEG,KOEND
                ztradgl(j,k) = tradin(k,ll) + (tradin(k,ll+1) -  &
	   		     tradin(k,ll))*(fl - ll)
                ztradgl(JD+1-j,k) = ztradgl(j,k)
              end do
            end do
          else
	    do k=KOBEG,KOEND
	      do j=1,JD/2
	        ztradgl(j,k) = tradin(k,j)
                ztradgl(JD+1-j,k) = ztradgl(j,k)
	      enddo
            enddo
          endif

!-----------------------------------------------------------------------
!     calculate the additional radiative damping terms ztrad1 and
!     ztrad2.
!-----------------------------------------------------------------------
          do k=KOBEG,KOEND
            do j=1,jdf
	      ztrad (j,k) = ztradgl(y(3)+j-1,k)
              ztrad1(j,k) = EXP(-bb1/ztrad(j,k))
              ztrad2(j,k) = EXP(-bb2/ztrad(j,k))
            end do
          end do
	  deallocate (ztradgl)
        endif

!---------------------------------------------------------------------
!     allocate space for the array which will hold the ozone field at
!     model levels and latitudes as a function of time 
!-------------------------------------------------------------------
      allocate (zdduo3n (jdf, KMIN:KMAX) )

!---------------------------------------------------------------------
    endif
    


end subroutine ozone_init


!#####################################################################

subroutine ozone_alloc

    allocate (qo3 (IMINP:IMAXP, JMINP:JMAXP, KSRAD:KERAD) )

end subroutine ozone_alloc



!####################################################################

subroutine ozone_dealloc

    deallocate (qo3 )

end subroutine ozone_dealloc



!####################################################################

subroutine get_ozone (qo3_out)

!--------------------------------------------------------------------
real, dimension(:,:,:), intent(out)   :: qo3_out

      qo3_out(ISRAD:IERAD,JSRAD:JERAD,KSRAD:KERAD) =     &
          qo3(ISRAD:IERAD,JSRAD:JERAD,KSRAD:KERAD) 

!--------------------------------------------------------------------

end subroutine get_ozone



!##################################################################

subroutine ozone_time_vary (Time)

!--------------------------------------------------------------------
type(time_type), intent(in), optional :: Time
! Time will be present when running in FMS
!--------------------------------------------------------------------

  real                               :: o3lag=104.0
  real, dimension(:,:), allocatable  :: dduo3n, zdduo3n_gl
  real                               :: o3day, arg, cosarg, sinarg,&
                                        cos2ar, xbar, a1, b1, b2, &
				        fl, displa, o3monf
  integer                            :: k, jsi, lli, im, imp, im1,&
				        j, i

  if (Environment%running_gcm) then
    if (Environment%using_sky_periphs .and. kmax == 40) then

!-----------------------------------------------------------------
!     if ozone data is to modified based on recent data, determine the 
!     necessary adjustment fields.
!-------------------------------------------------------------------
      if (do_tomsprofile1 .or. do_tomsprofile2 .or. do_randelprofile) &
               then

!-------------------------------------------------------------------
!     call calendar_o3monloss to obtain index for linear interpolation
!     into monthly ozone data fields.
!---------------------------------------------------------------------
	if (present (Time)) then
          call calendar_o3monloss (o3monf, im, im1, imp, Time=Time)
	else
          call calendar_o3monloss (o3monf, im, im1, imp)
	endif

!---------------------------------------------------------------------
!    now obtain a smoothly time-varying o3 loss profile. the altitude
!   (index values) of the depletion layers is set, as in the
!   annually averaged case, at the april values. latitude interpolation
!   to (JD) latitudes would be done here, if necessary.
!---------------------------------------------------------------------
        if (do_tomsprofile1) then
          do j = 1,jdf
            zdoblos(j) = o3depl_prof1(j+y(3)-1,im1) +    &
		         (o3depl_prof1(j+y(3)-1,imp) -  &
                         o3depl_prof1(j+y(3)-1,im)) *o3monf
            izdepb(j) = o3depb_prof1(j+y(3)-1)
            izdept(j) = o3dept_prof1(j+y(3)-1,2)
          enddo
        else if (do_tomsprofile2) then
          do j = 1,jdf
            zdoblos(j) = o3depl_prof2(j+y(3)-1,im1) +    &
		         (o3depl_prof2(j+y(3)-1,imp) -  &
                         o3depl_prof2(j+y(3)-1,im)) *o3monf
            izdepb(j) = o3depb_prof2(j+y(3)-1)
            izdept(j) = o3dept_prof2(j+y(3)-1,2)
          enddo
        endif
      endif

!--------------------------------------------------------------------
!     produce an ozone field at model levels and latitudes relevant at
!     the current time.
!--------------------------------------------------------------------
      if (do_seasonal_ozone) then

!----------------------------------------------------------------------
!     determine current time with respect to "ozone year" and write 
!     it out. determine argument for harmonic interpolation of seasonal
!     ozone data.
!----------------------------------------------------------------------
	if (present(Time)) then
          call calendar_4seasons_harmonic (o3lag, o3day, arg, Time=Time)
	else
          call calendar_4seasons_harmonic (o3lag, o3day, arg)
	endif
       
        if ( get_my_pe() == 0 .and. verbose) write (*,90010) o3day

!--------------------------------------------------------------------
!     if the ozone field is to be seasonally varying, do an harmonic 
!     time interpolation of the seasonal (xo3sf, xo3ws) ozone data 
!     which is provided at model levels on a ten degree 
!     latitude grid to the current time. ozone data is specified quart-
!     erly, (po4 - o3lag) days before the beginning of each quarter of 
!     the year, with 03day 1.0 being -12.75 or -12.50 days before jan 1,
!     (i.e., after), depending on whether or not it is a leap year. 
!     arg is the displacement of the given day in the ozone year, while 
!     cosarg, sinarg and cos2ar are functions used in the harmonic 
!     interpolation of the specified data to the given date.
!--------------------------------------------------------------------
	allocate (dduo3n (19, KMAX) )
        cosarg = COS(arg)
        sinarg = SIN(arg)
        cos2ar = COS(2.0E+00*arg)
        do k=KMIN,KMAX
          do j=1,19
            jsi = 20 - j
            xbar         = 0.25E+00*(xo3ws(j,k) + xo3ws(jsi,k) +  &
                           xo3sf(j,k) + xo3sf(jsi,k))
            a1           = 0.50E+00*(xo3sf(j,k) - xo3sf(jsi,k))
            b1           = 0.50E+00*(xo3ws(j,k) - xo3ws(jsi,k))
            b2           = 0.25E+00*(xo3ws(j,k) + xo3ws(jsi,k) -  &
                           xo3sf(j,k) -  xo3sf(jsi,k))
            dduo3n(jsi,k) = xbar + a1*sinarg + b1*cosarg + b2*cos2ar
          end do
        end do

!----------------------------------------------------------------------
!     convert this time-interpolated ozone field to model latitudes and 
!     levels (zdduo3n). ozone data in dduo3n is in 10**4 gm/gm. the 
!     multiplicative factor puts ozone data into (g/g), as a mass mix-
!     ing ratio.
!-----------------------------------------------------------------------
	allocate (zdduo3n_gl (jd, kmin:kmax) )
        do k=KMIN,KMAX
          do j=1,JD
            fl     = 9.0E+00 - 9.0E+00*(FLOAT(JD+1 - j - JD/2) -  &
                     0.5E+00)/FLOAT(JD/2)
            displa = fl - INT(fl)
            lli    = INT(fl) + 1
            zdduo3n_gl(j,k) = 1.0E-04*(dduo3n(lli,k) + displa*  &
                           (dduo3n(lli+1,k) - dduo3n(lli,k)))
          end do
        end do
	do k=KMIN,KMAX
	  do j=1,jdf
	    zdduo3n(j,k) = zdduo3n_gl(j+y(3)-1,k)
          end do
        end do
	deallocate (zdduo3n_gl)
	deallocate (dduo3n )

      else if (do_annual_mean_ozone) then

!-----------------------------------------------------------------------
!     for the annual mean ozone case, interpolate the provided data 
!     (xo3ann) at model levels and every 10 degrees of  latitude to the
!     model latitudes, producing the zdduo3n array. ozone data in xo3ann
!     is in 10**4 gm/gm . the multiplicative factor puts ozone data into
!     (g/g), as a mass mixing ratio.
!-----------------------------------------------------------------------
	allocate (zdduo3n_gl (jd, kmin:kmax) )
        do k=KMIN,KMAX
          do j=1,JD
            fl     = 9.0E+00 - 9.0E+00*(FLOAT(JD+1 - j - JD/2) -   &
                     0.5E+00)/FLOAT(JD/2)
            displa = fl - INT(fl)
            lli    = INT(fl) + 1
            zdduo3n_gl(j,k) = 1.0E-04*(xo3ann(lli,k) + displa*  &
                           (xo3ann(lli+1,k) - xo3ann(lli,k)))
          end do
        end do
	do k=KMIN,KMAX
	  do j=1,jdf
	    zdduo3n(j,k) = zdduo3n_gl(j+y(3)-1, k)
          end do
        end do
	deallocate (zdduo3n_gl)
      else if (do_randelprofile) then

!-----------------------------------------------------------------------
!     time interpolate the monthly randel profile data
!----------------------------------------------------------------------
        do k=KMIN,KMAX
          do j = 1,jdf
            zdduo3n(j,k) = qo3_randel(j,k,im1) +   &
                    (qo3_randel(j,k,imp) - qo3_randel(j,k,im)) * o3monf
          enddo
        enddo

      else if (do_column_input) then

!-----------------------------------------------------------------------
!     use single column ozone data read in from disk
!----------------------------------------------------------------------
        do k=KMIN,KMAX
          do j = 1,jdf
            zdduo3n(j,k) = qqo3(k)
          enddo
        enddo
      endif
    else if (Environment%using_sky_periphs .and. do_column_input) then

!-----------------------------------------------------------------------
!     use single column ozone data read in from disk
!----------------------------------------------------------------------
      do k=KMIN,KMAX
        do j = 1,jdf
          zdduo3n(j,k) = qqo3(k)
        enddo
      enddo

    endif ! (using sky_periphs and KMAX == 40)

  else if (Environment%running_standalone) then
!-----------------------------------------------------------------------
!     use single column ozone data read in from disk
!----------------------------------------------------------------------
    do k=KMIN,KMAX
      do j = 1,jdf
        zdduo3n(j,k) = qqo3(k)
      enddo
    enddo
  endif ! (running_gcm)

!-------------------------------------------------------------------

90010 format(/ 5x, 'o3day=', f9.4 )

!-------------------------------------------------------------------


end subroutine ozone_time_vary




!####################################################################



subroutine ozone_drvr 
 
!------------------------------------------------------------------- 
    real, dimension (:,:), allocatable    :: tcolo3
    real, dimension (:,:,:), allocatable  :: em, vx1, vx2
    real, dimension (:,:,:), allocatable  :: phaf
    integer                               :: k,j,i
    real  :: o3ducst=466.968 ! conversion factor from dobson units to 
                             ! cgs units
 
    if (Environment%using_sky_periphs .and. kmax == 40) then

      if (do_ozone_adjustment) then
!-----------------------------------------------------------------------
!     add a photochemical adjustment as a function of temperature  to
!     the ozone amount in layers above 35 Km (layers KOBEG-KOEND). This 
!     is a "poor man's ozone chemistry".
!-----------------------------------------------------------------------
        allocate (tcolo3 (IMINP:IMAXP, JMINP:JMAXP) )
        allocate (em     (IMINP:IMAXP, JMINP:JMAXP, KMIN:KMAX  ) )
        allocate (vx1    (IMINP:IMAXP, JMINP:JMAXP, KOBEG:KOEND) )
        allocate (vx2    (IMINP:IMAXP, JMINP:JMAXP, KOBEG:KOEND) )

        em (:,:,KMIN:KMAX  ) = 1.0E+00
        vx1(:,:,KOBEG:KOEND) = EXP(bb1/temp(:,:,KOBEG:KOEND))
        vx2(:,:,KOBEG:KOEND) = EXP(-bb2/temp(:,:,KOBEG:KOEND))
        vx2(:,:,KOBEG:KOEND) = 1.0E+00/(con1 + vx2(:,:,KOBEG:KOEND))
        do k=KOBEG,KOEND
          do j=JMINP,JMAXP
            do i=IMINP,IMAXP
              em (i,j,k) = SQRT(ztrad(jabs(j),k)/   &
                                temp(i,j,k)*(vx1(i,j,k)*   &
                                ztrad1(jabs(j),k)*(con1 +    &
                                ztrad2(jabs(j),k))*vx2(i,j,k)))
            end do
          end do
        end do

!-----------------------------------------------------------------------
!   define the (i,j,k) ozone field valid at the current time, including
!   the effect of the photochemical adjustment.
!-----------------------------------------------------------------------
        do k=KMIN,KMAX
          do j=JMINP,JMAXP
            do i=IMINP,IMAXP
              qo3(i,j,k) = zdduo3n(jabs(j),k)*em(i,j,k)
            enddo
          enddo
        enddo
      else
        do k=KMIN,KMAX
          do j=JMINP,JMAXP
            do i=IMINP,IMAXP
              qo3(i,j,k) = zdduo3n(jabs(j),k)
            enddo
          enddo
        enddo
      endif
!----------------------------------------------------------------------
!   if ozone is to be depleted, calculate the value to be used.
!   evaluate the column ozone, in dobson units, in the skyhi layers
!  (idept-idepb) (ie, those in which ozone change is to occur)
!----------------------------------------------------------------------
      if (do_tomsprofile1 .or. do_tomsprofile2) then
        tcolo3(:,:) = 0.0E+00
        do j=JMINP,JMAXP
	  do i=IMINP,IMAXP
            do k=izdept(jabs(j)), izdepb(jabs(j))
	      tcolo3(i,j) = tcolo3(i,j) + o3ducst*1.0E+03*qo3(i,j,k)* &
                      0.5E+00*(press(i,j,k+1) - press(i,j,k-1))/grav
	    enddo
            do k=izdept(jabs(j)), izdepb(jabs(j))
              qo3(i,j,k) = qo3(i,j,k)*(1.0E+00 + zdoblos(jabs(j))/  &
			   tcolo3(i,j))
	    enddo
          enddo
        enddo
      endif
!--------------------------------------------------------------------

      if (do_ozone_adjustment) then
        deallocate (vx1   )
        deallocate (vx2   )
        deallocate (em    )
        deallocate (tcolo3)
      endif

    else   ! (using_fms_periphs or kmax /= 40)
      allocate (phaf(IMINP:IMAXP, JMINP:JMAXP, KSRAD:KERAD+1) )
      do k=KSRAD,KERAD+1
        phaf(:,:,k) = pflux(:,:,k)*101325./pflux(:,:,KERAD+1)
      end do

      call zonal_ozone (Rad_time_sv, lat_sv, phaf, qo3   )

      deallocate (phaf  )
    endif

!-------------------------------------------------------------------
!    send ozone field to radiation_diag_mod and to archive_package 
!    for processing
!-------------------------------------------------------------------
    if (Rad_control%do_diagnostics) then
      do j=JMINP,JMAXP
        call radiag_from_ozone (j, qo3)
      end do
    endif

    call hold_qo3 (qo3)
!-------------------------------------------------------------------



end subroutine ozone_drvr


!###################################################################




                  end module ozone_mod
