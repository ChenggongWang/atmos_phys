<HTML>
<TITLE>module radiation_driver_mod</TITLE>
<BODY BGCOLOR="#AABBCC" TEXT="#332211" >

<DIV ALIGN="CENTER"> <FONT SIZE=1>
<A HREF="#INTERFACE">PUBLIC INTERFACE</A> / 
<A HREF="#ROUTINES">ROUTINES</A> / 
<A HREF="#NAMELIST">NAMELIST</A> / 
<A HREF="#DIAGNOSTICS">DIAGNOSTICS</A> / 
<A HREF="#CHANGES">CHANGES</A> / 
<A HREF="#ERRORS">ERRORS</A> / 
<A HREF="#REFERENCES">REFERENCES</A> / 
<A HREF="#NOTES">NOTES</A> 
</FONT>
<BR><BR></DIV><HR>


<H2>Module radiation_driver_mod</H2>
<A NAME="HEADER">
<PRE>
     <B>Contact:</B>   Bruce Wyman
     <B>Reviewers:</B>

     <B><A HREF=".doc.log#radiation_driver.f90">Tags/Status</A></B>
</PRE>
</A><!-- END HEADER -->
<!--------------------------------------------------------------------->
<A NAME="OVERVIEW">
<HR>
<H4>OVERVIEW</H4>
<!-- BEGIN OVERVIEW -->
<PRE>

A driver for radiation related processes and diagnostics.

</PRE>
</A><!-- END OVERVIEW -->
<!--------------------------------------------------------------------->
<A NAME="DESCRIPTION">
<!-- BEGIN DESCRIPTION -->
<PRE>

The following modules are called from this driver module:

   1) astronomy
   2) cloud properties
   3) prescribed zonal ozone
   4) longwave and shortwave radiation driver

</PRE>
</A><!-- END DESCRIPTION -->
<!--------------------------------------------------------------------->
<A NAME="MODULES_USED">
<HR>
<H4>OTHER MODULES USED</H4>
<!-- BEGIN MODULES_USED -->
<PRE>

           fsrad_mod
       astronomy_mod
     zonal_ozone_mod
          clouds_mod
     strat_cloud_mod
    time_manager_mod
   diag_integral_mod
    diag_manager_mod
       constants_mod
       utilities_mod

</PRE>
</A><!-- END MODULES_USED -->
<!--------------------------------------------------------------------->
<A NAME="INTERFACE">
<HR>
<H4>PUBLIC INTERFACE</H4>
<!-- BEGIN INTERFACE -->
<PRE>

<b>use radiation_driver_mod</b> [,only: radiation_driver_init,
                                 radiation_driver,
                                 radiation_driver_end]

   <a href="radiation_driver.doc.html#radiation_driver_init">radiation_driver_init</a>
       Must be called once before subroutine radiation_driver to
       initialize the module (read namelist input and restart file).
       Also calls the initialization routines for other modules used.

   <a href="radiation_driver.doc.html#radiation_driver">radiation_driver</a>
       Called every time step (not on the radiation time step)
       to compute the longwave and shortwave radiative tendencies.

   <a href="radiation_driver.doc.html#radiation_driver_end">radiation_driver_end</a>
       Called once at the end of a model run to terminate the module (write
       a restart file). Also calls the termination routines for other
       modules used.

Notes:
 1) A namelist interface controls runtime options.
 3) A restart file <b>radiation_driver.res</b> is generated by this module.

</PRE>
</A><!-- END INTERFACE -->
<!--------------------------------------------------------------------->
<A NAME="ROUTINES">
<HR>
<H4>PUBLIC ROUTINES</H4>
<!-- BEGIN ROUTINES -->
<PRE>
<a name="radiation_driver_init">

call radiation_driver_init (lonb, latb, pref, axes, Time)

input

    lonb      Longitude in radians for all (i.e., the global size)
              grid box boundaries, the size of lonb should be one more
              than the global number of longitude points along the x-axis.
                 [real, dimension(:)]

    latb      Latitude in radians for all (i.e., the global size)
              grid box boundaries, the size of latb should be one more
              than the global number of latitude points along the y-axis.
                 [real, dimension(:)]

    pref      Two reference profiles of pressure at full model levels
              plus the surface (nlev+1). The first profile assumes a surface
              pressure of 101325 pa, and the second profile assumes 
              81060 pa.  [real, dimension(nlev+1,2)]

    axes      The axis indices that are returned by previous calls to
              diag_axis_init. The values of this array correspond to the
              x, y, full (p)level, and half (p)level axes. These are the
              axes that diagnostic fields are output on.
                 [integer, dimension(4)]

    Time      The current time.  [time_type]
                                                            
---------------------------------------------------------------------
<a name="radiation_driver">

call radiation_driver (is, ie, js, je, Time, Time_next, lat, lon,
                       pfull, phalf, t, q, ts, land, albedo,
                       tdt, flux_sw, flux_lw, coszen,
                       [, mask, kbot] )

input

    is,ie,js,je  starting/ending i,j indices in global storage arrays
                   [integer]

    Time       The time for determining whether radiation should be done.
               This is used as the radiative time unless namelist variable
               rad_time has been specified.   [time_type]

    Time_next  The time used for diagnostic output.   [time_type]

    lat        mean latitude (in radians) of all grid boxes processed by this
               call to radiation_driver   [real, dimension(:,:)]

    lon        mean longitude (in radians) of all grid boxes processed by
               this call to radiation_driver   [real, dimension(:,:)]

    pfull      pressure at full model levels [real, dimension(:,:,nlev)]

    phalf      pressure at half model levels [real, dimension(:,:,nlev+1)]

    t          mean temperature in (full) model layers (in deg K)
                 [real, dimension(:,:,nlev)]

    q          specific humidity of water vapor in (full) model layers
               in kg/kg      [real, dimension(:,:,nlev)]

    ts         surface (skin) temperature (in deg k) [real, dimension(:,:)]

    land       fraction (0. to 1.) of surface which covered by land
                 [real, dimension(:,:)]

    albedo     surface albedo  [real, dimension(:,:)]

input/output

    tdt        temperature tendency in (full) model layers (in deg K/sec)
                 [real, dimension(:,:,nlev)]

output

    flux_sw    net shortwave surface flux (down minus up) (in watts/m**2)
                 [real, dimension(:,:)]

    flux_lw    downward longwave surface flux (in watts/m**2)
                 [real, dimension(:,:)]

    coszen     cosine of the zenith angle
                 [real, dimension(:,:)]

input (optional)

    mask       mask (1. or 0.) for grid boxes above or below
               the ground, usually only necessary for the step-mountain
               (eta) vertical coordinate  [real, dimension(:,:,nlev)]

    kbot       index of the lowest model level, usually only necessary
               for the step-mountain (eta) vertical coordinate
                 [integer, dimension(:,:)]

---------------------------------------------------------------------
<a name="radiation_driver_end">

call radiation_driver_end

   There are no arguments for this routine.

</PRE>
</A><!-- END ROUTINES -->
<!--------------------------------------------------------------------->
<A NAME="NAMELIST">
<HR>
<H4>NAMELIST</H4>
<!-- BEGIN NAMELIST -->
<PRE>

&radiation_driver_nml

  dt_rad             The radiative time step in seconds.
                       [integer, default: dt_rad=43200]

  offset             An offset for radiative time step (in seconds).
                     Note: If offset=1 then radiation will be done on the first
                     time step after t=0, dt_rad, 2*dt_rad, etc.
                     FOR NOW DO NOT CHANGE THIS VALUE
                       [integer, default: offset=1]

  do_diurnal         Switch to turn on/off diurnal radiation.
                       [logical, default: do_diurnal=.false.]

  do_annual          Switch to turn on/off mean annual radiation. 
		     NB: Fatal error results if do_diurnal==.true. and do_annual==.true.
                       [logical, default: do_annual=.false.]

  do_average         Switch to turn on/off time averaged input data over the radiation
                     time step. Turning this option ON will increase the amount of
                     memory needed.   [logical, default: do_average=.false.]

  do_clear_sky_diag  Switch to turn on/off the archiving diagnostics with and
                     without clouds. Note that diagnostics fields must also be
                     selected (see diagnostic variables).
                       [logical, default: do_clear_sky_diag=.false.]

  solar_constant     The solar constant in watts/m2.
                       [real, default: solar_constant=1365.]

  rsd                Switch that determines whether repeating-single-day forcing is to be used. Used with
		     rad_date (see below).
			[logical, default: false]

  rad_date           A fixed date (year,month,day,hour,min,sec) for the radiation 
                     calculation. This date will be used for the solar information,
                     prescribed ozone, and prescribed clouds. If no year is
                     specified (rad_date(1)=0) then the input argument time
                     (see interface radiation_driver) will be used, this is the default. 
		     If rsd=.true., the (year,month,day) entries are used as the single fixed calendar date
		     for a repeating-single-day integration, and the time of day used is the model time of day.
                       [real, dimension(6), default: rad_date=0,0,0,0,0,0]

  co2std             The standard co2 volume mixing ratio (either 300 or 330 ppmv).
                       [real, default: co2std=330.]

  ratio              The co2 volume mixing ratio in units of the standard volume
                     mixing ratio (co2std), where ratio must lie between 0.5 and 4.0.
                       [real, default: ratio=1.0]

  ipt,jpt	     Specify columns in which radiation diagnostics are desired. [integer, default: ipt = -35, jpt = -35]

Note:

  * If do_diurnal = do_annual = false then daily mean radiation will be computed.
    This is the default.
  * do_diurnal = do_annual should both not be true. The current implementation
    does not prevent this, and although do_diurnal should override this may not
    always be the case.
  * Errors may occur when using anything other than the default values for
    co2std or ratio. It is recommended that you test different values before
    using them in long integrations. 

</PRE>
</A><!-- END NAMELIST -->
<!--------------------------------------------------------------------->
<A NAME="DIAGNOSTICS">
<HR>
<H4>DIAGNOSTIC FIELDS</H4>
<PRE>
Diagnostic fields may be output to a netcdf file by specifying the
module name <b>radiation</b> and the desired field names (given below)
in file <b>diag_table</b>. See the documentation for diag_manager.
</PRE>
<!-- BEGIN DIAGNOSTICS -->
<PRE>

Diagnostic fields for module name: <b>radiation</b>

   field name      field description
   ----------      -----------------

   alb_sfc         surface albedo (percent)
   coszen          cosine of the solar zenith angle

   tdt_sw          temperature tendency for SW radiation (deg_K/sec)
   tdt_lw          Temperature tendency for LW radiation (deg_K/sec)
   swdn_toa        SW flux down at TOA (watts/m2)
   swup_toa        SW flux up at TOA (watts/m2)
   olr             outgoing longwave radiation (watts/m2)
   swup_sfc        SW flux up at surface (watts/m2)
   swdn_sfc        SW flux down at surface (watts/m2)
   lwup_sfc        LW flux up at surface  (watts/m2)
   lwdn_sfc        LW flux down at surface (watts/m2)

NOTE: When namelist variable <b>do_clear_sky_diag = .true.</b> an additional clear sky
      diagnostic fields may be saved.

   tdt_sw_clr      clear sky temperature tendency for SW radiation (deg_K/sec)
   tdt_lw_clr      clear sky Temperature tendency for LW radiation (deg_K/sec)
   swdn_toa_clr    clear sky SW flux down at TOA (watts/m2)
   swup_toa_clr    clear sky SW flux up at TOA (watts/m2)
   olr_clr         clear sky outgoing longwave radiation (watts/m2)
   swup_sfc_clr    clear sky SW flux up at surface (watts/m2)
   swdn_sfc_clr    clear sky SW flux down at surface (watts/m2)
   lwup_sfc_clr    clear sky LW flux up at surface  (watts/m2)
   lwdn_sfc_clr    clear sky LW flux down at surface (watts/m2)


</PRE>
</A><!-- END DIAGNOSTICS -->
<!--------------------------------------------------------------------->
<A NAME="DATA_SETS">
<HR>
<H4>DATA SETS</H4>
<!-- BEGIN DATA_SETS -->
<PRE>

<b>CO2 transmission functions</b>
     Several ascii files are required that can be easily setup by a
     script for getting physics data sets.

<b>Restart file</b>
     A restart data set called <b>radiation_driver.res</b> saves the
     global fields for the current radiative tendency, net shortwave
     surface flux, downward longwave surface flux, and cosine of the
     zenith angle. If the namelist variable do_average=true,
     then additional time averaged global data is written.
     If the restart file is not present when initializing then the
     radiative tendency is set to zero, the SW and LW surface fluxes
     to 50 watts/m2, and the cosine of the zenith angle to 0.50.
     Since radiation is usually computed on the first time step when
     restarting, these values may have little or no effect.  If the
     restart file is not present time average data is also set to zero.

</PRE>
</A><!-- END DATA_SETS -->
<!--------------------------------------------------------------------->
<A NAME="CHANGES">
<HR>
<H4>CHANGE HISTORY</H4>
<!-- BEGIN CHANGES -->
<PRE>
<B><A HREF=".doc.log#radiation_driver.f90">CVS revision history</A></B>

<b>changes prior to 1/24/2000</b>

  * Modified the radiation alarm. 
    The module can now be stopped/started on a time step that is not the
    radiation time step.

  * Modified the radiation restart format.
    Added a version number and radiation alarm information.

  * Fixed a bug that occurred when namelist variable do_average = true.
    An addition averaging variable was added for array "solar". 
    This averaging information was also added to the restart file.

  * Removed the initialization for the astronomy package. This is now done
    by the astronomy namelist.

<b>changes prior to 10/4/1999</b>

  * MPP version created. Changes to open_file and error_mesg arguments, 
    Fortran write statements to standard output only on PE 0, Fortran close
    statement changed to call close_file, and Fortran read/write statements
    for restart files changed to call read_data/write_data.

  * Implementation of the new MPP diagnostics package. This required major
    changes to the diagnostic interface and the manner in which diagnostics
    quantities are selected.

  * There were no changes made that would cause answers to changes.


<b>changes prior to 5/26/1999</b>

  * added namelist variables for modifying the co2 mixing ratio.

  * changed the units of namelist variable solar_constant from ly/min to watts/m2.

</PRE>
</A><!-- END CHANGES -->
<!--------------------------------------------------------------------->
<A NAME="ERRORS">
<HR>
<H4>ERROR MESSAGES</H4>
<!-- BEGIN ERRORS -->
<PRE>

<b>Fatal errors in radiation_driver_init:</b>

    <b>must have two reference pressure profile</b>
       The input argument <b>pref</b> must have a second dimension size of 2.

    <b>restart version ## cannot be read by this module version</b>
       You have attempted to read a radiation_driver.res file with either
       no restart version number or an incorrect restart version number.

<b>Fatal errors in radiation_driver:</b>

    <b>radiation_driver_init must first be called</b>
       You have not called radiation_driver_init before calling
       radiation_driver.

    <b>Time_next <= Time</b>
       Time arguments to radiation_driver are producing a time step <= 0.
       Check that the time argumnets passed to the physics_driver are
       correct.
       

<b>Fatal errors in return_average in radiation_driver_mod:</b>

    <b>dividing average by zero</b>
       There is no data in the time average data buffer.
       This error is very unlikely. Check with the contact person.

<b>Notes given in radiation_driver_init:</b>

    <b>radiation time step has changed, next radiation time also changed</b>
       The radiation time step from the namelist input did not match
       the radiation time step from the radiation restart file.
       The next time for radiation will be adjusted for the new  namelist
       input) value.
       
</PRE>
</A><!-- END ERRORS -->
<!--------------------------------------------------------------------->
<A NAME="REFERENCES">
<HR>
<H4>REFERENCES</H4>
<!-- BEGIN REFERENCES -->
<PRE>

     For a specific list of radiation references see the
     longwave and shortwave documentation.

</PRE>
</A><!-- END REFERENCES -->
<!--------------------------------------------------------------------->
<A NAME="BUGS">
<HR>
<H4>KNOWN BUGS</H4>
<!-- BEGIN BUGS -->
<PRE>

  * The current implementation does not prevent both do_diurnal=,true.
    and do_annual=.true.  The result may not be what the user desires.

  * Errors may occur when using anything other than the default values for
    namelist variable co2std or ratio. It is recommended that you test
    values different from the default values before using them in long integrations. 

  * For some of the diagnostics fields that represent fractional amounts,
    such as reflectivity and absorptivity, the units are incorrectly
    given as percent.

</PRE>
</A><!-- END BUGS -->
<!--------------------------------------------------------------------->
<A NAME="NOTES">
<HR>
<H4>NOTES</H4>
<!-- BEGIN NOTES -->
<PRE>

     There are no developer notes.

</PRE>
</A><!-- END NOTES -->
<!--------------------------------------------------------------------->
<A NAME="PLANS">
<HR>
<H4>FUTURE PLANS</H4>
<!-- BEGIN PLANS -->
<PRE>

     * Interface for new longwave and shortwave radiation programs.

</PRE>
</A><!-- END PLANS -->
<!--------------------------------------------------------------------->

<HR>
</BODY>
</HTML>
